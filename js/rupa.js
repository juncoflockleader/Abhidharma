const rupa = {
    name: t('string_id_499'),
    children: [
        {
            name: t('string_id_500'),
            children: [
                {
                    name: t('string_id_501'),
                    children: [
                        {
                            name: t('string_id_502'),
                            id: 1,
                            character: t('string_id_503'),
                            functions: t('string_id_504'),
                            manifestation: t('string_id_505'),
                            cause: t('string_id_506')
                        },
                        {
                            name: t('string_id_507'),
                            id: 2,
                            character: t('string_id_508'),
                            functions: t('string_id_509'),
                            manifestation: t('string_id_510'),
                            cause: t('string_id_506')
                        },
                        {
                            name: t('string_id_511'),
                            id: 3,
                            character: t('string_id_512'),
                            functions: t('string_id_513'),
                            manifestation: t('string_id_514'),
                            cause: t('string_id_506')
                        },
                        {
                            name: t('string_id_515'),
                            id: 4,
                            character: t('string_id_516'),
                            functions: t('string_id_517'),
                            manifestation: t('string_id_518'),
                            cause: t('string_id_506')
                        },
                    ]
                }
            ]
        },
        {
            name: t('string_id_519'),
            children: [
                {
                    name: t('string_id_520'),
                    children: [
                        {
                            name: t('string_id_133'),
                            id: 5,
                            character: t('string_id_521'),
                            functions: t('string_id_522'),
                            manifestation: t('string_id_523'),
                            cause: t('string_id_524')
                        },
                        {
                            name: t('string_id_137'),
                            id: 6,
                            character: t('string_id_525'),
                            functions: t('string_id_526'),
                            manifestation: t('string_id_527'),
                            cause: t('string_id_528')
                        },
                        {
                            name: t('string_id_140'),
                            id: 7,
                            character: t('string_id_529'),
                            functions: t('string_id_530'),
                            manifestation: t('string_id_531'),
                            cause: t('string_id_532')
                        },
                        {
                            name: t('string_id_143'),
                            id: 8,
                            character: t('string_id_533'),
                            functions: t('string_id_534'),
                            manifestation: t('string_id_535'),
                            cause: t('string_id_536')
                        },
                        {
                            name: t('string_id_147'),
                            id: 9,
                            character: t('string_id_537'),
                            functions: t('string_id_538'),
                            manifestation: t('string_id_539'),
                            cause: t('string_id_540')
                        },
                    ]
                },
                {
                    name: t('string_id_541'),
                    children: [
                        {
                            name: t('string_id_729'),
                            id: 10,
                            character: t('string_id_542'),
                            functions: t('string_id_543'),
                            manifestation: t('string_id_544'),
                            cause: t('string_id_545')
                        },
                        {
                            name: t('string_id_546'),
                            id: 11,
                            character: t('string_id_547'),
                            functions: t('string_id_548'),
                            manifestation: t('string_id_549'),
                            cause: t('string_id_545')
                        },
                        {
                            name: t('string_id_550'),
                            id: 12,
                            character: t('string_id_551'),
                            functions: t('string_id_552'),
                            manifestation: t('string_id_553'),
                            cause: t('string_id_545')
                        },
                        {
                            name: t('string_id_554'),
                            id: 13,
                            character: t('string_id_555'),
                            functions: t('string_id_556'),
                            manifestation: t('string_id_557'),
                            cause: t('string_id_545')
                        },
                        {
                            name: t('string_id_9'),
                            alias: t('string_id_558'),
                            id: -1,
                            character: t('string_id_559'),
                            functions: t('string_id_560'),
                            manifestation: t('string_id_561'),
                            cause: t('string_id_545')
                        },
                    ]
                },
                {
                    name: t('string_id_562'),
                    children: [
                        {
                            name: t('string_id_563'),
                            id: 14,
                            character: t('string_id_564'),
                            functions: t('string_id_565'),
                            manifestation: t('string_id_566'),
                            cause: t('string_id_567')
                        },
                        {
                            name: t('string_id_568'),
                            id: 15,
                            character: t('string_id_569'),
                            functions: t('string_id_570'),
                            manifestation: t('string_id_571'),
                            cause: t('string_id_567')
                        },
                    ]
                },
                {
                    name: t('string_id_572'),
                    children: [
                        {
                            name: t('string_id_572'),
                            id: 16,
                            alias: t('string_id_573'),
                            character: t('string_id_574'),
                            functions: t('string_id_575'),
                            manifestation: t('string_id_576'),
                            cause: t('string_id_567')
                        },
                    ]
                },
                {
                    name: t('string_id_577'),
                    children: [
                        {
                            name: t('string_id_577'),
                            id: 17,
                            character: t('string_id_578'),
                            functions: t('string_id_579'),
                            manifestation: t('string_id_580'),
                            cause: t('string_id_567')
                        },
                    ]
                },
                {
                    name: t('string_id_581'),
                    children: [
                        {
                            name: t('string_id_581'),
                            alias: t('string_id_582'),
                            id: 18,
                            character: t('string_id_583'),
                            functions: t('string_id_584'),
                            manifestation: t('string_id_585'),
                            cause: t('string_id_586')
                        },
                    ]
                },
                {
                    name: t('string_id_587'),
                    children: [
                        {
                            name: t('string_id_587'),
                            alias: t('string_id_588'),
                            id: 19,
                            character: t('string_id_589'),
                            functions: t('string_id_590'),
                            manifestation: t('string_id_591'),
                            cause: t('string_id_592')
                        },
                    ]
                },
                {
                    name: t('string_id_593'),
                    children: [
                        {
                            name: t('string_id_594'),
                            id: 20,
                            character: t('string_id_595'),
                            functions: t('string_id_596'),
                            manifestation: t('string_id_597'),
                            cause: t('string_id_598'),
                            extra: t('string_id_599')
                        },
                        {
                            name: t('string_id_600'),
                            id: 21,
                            character: t('string_id_601'),
                            functions: t('string_id_602'),
                            manifestation: t('string_id_603'),
                            cause: t('string_id_604'),
                            extra: t('string_id_605')
                        },
                    ]
                },
                {
                    name: t('string_id_606'),
                    children: [
                        {
                            name: t('string_id_607'),
                            id: 22,
                            character: t('string_id_608'),
                            functions: t('string_id_609'),
                            manifestation: t('string_id_610'),
                            cause: t('string_id_611')
                        },
                        {
                            name: t('string_id_612'),
                            id: 23,
                            character: t('string_id_613'),
                            functions: t('string_id_614'),
                            manifestation: t('string_id_615'),
                            cause: t('string_id_616')
                        },
                        {
                            name: t('string_id_617'),
                            id: 24,
                            character: t('string_id_618'),
                            functions: t('string_id_619'),
                            manifestation: t('string_id_620'),
                            cause: t('string_id_621')
                        },
                    ]
                },
                {
                    name: t('string_id_622'),
                    children: [
                        {
                            name: t('string_id_623'),
                            id: 25,
                            character: t('string_id_624'),
                            functions: t('string_id_625'),
                            manifestation: t('string_id_626'),
                            cause: t('string_id_627')
                        },
                        {
                            name: t('string_id_628'),
                            id: 26,
                            character: t('string_id_629'),
                            functions: t('string_id_630'),
                            manifestation: t('string_id_631'),
                            cause: t('string_id_632')
                        },
                        {
                            name: t('string_id_633'),
                            id: 27,
                            character: t('string_id_634'),
                            functions: t('string_id_635'),
                            manifestation: t('string_id_636'),
                            cause: t('string_id_637')
                        },
                        {
                            name: t('string_id_638'),
                            id: 28,
                            character: t('string_id_639'),
                            functions: t('string_id_640'),
                            manifestation: t('string_id_641'),
                            cause: t('string_id_642')
                        },
                    ]
                }
            ]
        }
    ]
};

const rupaClass = [
    {
        name: t('string_id_643'),
        id: 101,
        values: [t('string_id_644'), t('string_id_645')],
        notes: t('string_id_646'),
        rupa: [t('string_id_133'), t('string_id_137'), t('string_id_140'), t('string_id_143'), t('string_id_147')]
    },
    {
        name: t('string_id_647'),
        id: 102,
        values: [t('string_id_648'), t('string_id_649')],
        notes: t('string_id_650'),
        rupa: [t('string_id_133'), t('string_id_137'), t('string_id_140'), t('string_id_143'), t('string_id_147'), t('string_id_572')]
    },
    {
        name: t('string_id_651'),
        id: 103,
        values: [t('string_id_728'), t('string_id_652')],
        notes: t('string_id_653'),
        rupa: [t('string_id_133'), t('string_id_137'), t('string_id_140'), t('string_id_143'), t('string_id_147'), t('string_id_594'), t('string_id_600')]
    },
    {
        name: t('string_id_654'),
        id: 104,
        values: [t('string_id_655'), t('string_id_656')],
        notes: t('string_id_657'),
        rupa: [t('string_id_133'), t('string_id_137'), t('string_id_140'), t('string_id_143'), t('string_id_147'), t('string_id_568'), t('string_id_563'), t('string_id_577')]
    },
    {
        name: t('string_id_658'),
        id: 105,
        values: [t('string_id_659'), t('string_id_660')],
        notes: t('string_id_661'),
        rupa: [t('string_id_502'), t('string_id_511'), t('string_id_515'), t('string_id_133'), t('string_id_137'), t('string_id_140'), t('string_id_143'), t('string_id_147'), t('string_id_729'), t('string_id_546'), t('string_id_550'), t('string_id_554')]
    },
    {
        name: t('string_id_662'),
        id: 106,
        values: [t('string_id_663'), t('string_id_664'), t('string_id_665')],
        notes: t('string_id_666'),
        rupa: [t('string_id_133'), t('string_id_137'), t('string_id_140'), t('string_id_143'), t('string_id_147'), t('string_id_568'), t('string_id_563'), t('string_id_572'), t('string_id_577')],
        extra: [t('string_id_502'), t('string_id_507'), t('string_id_511'), t('string_id_515'), t('string_id_729'), t('string_id_550'), t('string_id_554'), t('string_id_581'), t('string_id_587')]
    },
    {
        name: t('string_id_667'),
        id: 107,
        values: [t('string_id_668'), t('string_id_669'), t('string_id_665')],
        notes: t('string_id_670'),
        rupa: [],
        extra: [t('string_id_729')]
    },
    {
        name: t('string_id_671'),
        id: 108,
        values: [t('string_id_672'), t('string_id_673'), t('string_id_674')],
        notes: t('string_id_675'),
        rupa: [t('string_id_133'), t('string_id_137')],
        extra: [t('string_id_140'), t('string_id_143'), t('string_id_147')]
    },
    {
        name: t('string_id_676'),
        id: 109,
        values: [t('string_id_677'), t('string_id_678')],
        notes: t('string_id_679'),
        rupa: [t('string_id_502'), t('string_id_507'), t('string_id_511'), t('string_id_515'), t('string_id_729'), t('string_id_550'), t('string_id_554'), t('string_id_581')]
    },
];

const rupaCause = {
    name: t('string_id_680'),
    rupa: [t('string_id_502'), t('string_id_507'), t('string_id_511'), t('string_id_515'), t('string_id_729'), t('string_id_550'), t('string_id_554'), t('string_id_581')],
    children: [
        {
            name: t('string_id_681'),
            id: 201,
            rupa: [t('string_id_133'), t('string_id_137'), t('string_id_140'),
                t('string_id_143'), t('string_id_147'), t('string_id_563'), t('string_id_568'),
                t('string_id_572'), t('string_id_577'), t('string_id_587')]
        },
        {
            name: t('string_id_682'),
            id: 202,
            rupa: [t('string_id_546'), t('string_id_587'), t('string_id_594'), t('string_id_600'), t('string_id_607'), t('string_id_612'), t('string_id_617')]
        },
        {
            name: t('string_id_683'),
            id: 203,
            rupa: [t('string_id_546'), t('string_id_587'), t('string_id_607'), t('string_id_612'), t('string_id_617')]
        },
        {
            name: t('string_id_684'),
            id: 204,
            rupa: [t('string_id_587'), t('string_id_607'), t('string_id_612'), t('string_id_617')]
        }
    ]
};

const rupaAgg =
    {
        name: t('string_id_685'),
        rupa: [t('string_id_502'), t('string_id_507'), t('string_id_511'), t('string_id_515'), t('string_id_729'), t('string_id_550'), t('string_id_554'), t('string_id_581')],
        children: [
            {
                name: t('string_id_686'),
                rupa: [t('string_id_577')],
                children: [
                    {
                        name: t('string_id_687'),
                        id: 315,
                        rupa: [t('string_id_133')]
                    },
                    {
                        name: t('string_id_688'),
                        id: 316,
                        rupa: [t('string_id_137')]
                    },
                    {
                        name: t('string_id_689'),
                        id: 317,
                        rupa: [t('string_id_140')]
                    },
                    {
                        name: t('string_id_690'),
                        id: 318,
                        rupa: [t('string_id_143')]
                    },
                    {
                        name: t('string_id_691'),
                        id: 319,
                        rupa: [t('string_id_147')]
                    },
                    {
                        name: t('string_id_692'),
                        id: 320,
                        rupa: [t('string_id_563')]
                    },
                    {
                        name: t('string_id_693'),
                        id: 321,
                        rupa: [t('string_id_568')]
                    },
                    {
                        name: t('string_id_694'),
                        id: 322,
                        rupa: [t('string_id_572')]
                    },
                    {
                        name: t('string_id_695'),
                        id: 323,
                        rupa: []
                    },
                ]
            },
            {
                name: t('string_id_696'),
                rupa: [],
                children: [
                    {
                        id: 301,
                        name: t('string_id_697'),
                        rupa: []
                    },
                    {
                        id: 302,
                        name: t('string_id_698'),
                        rupa: [t('string_id_594')]
                    },
                    {
                        id: 303,
                        name: t('string_id_699'),
                        rupa: [t('string_id_546'), t('string_id_600')]
                    },
                    {
                        id: 304,
                        name: t('string_id_700'),
                        rupa: [t('string_id_607'), t('string_id_612'), t('string_id_617')]
                    },
                    {
                        id: 305,
                        name: t('string_id_701'),
                        rupa: [t('string_id_607'), t('string_id_612'), t('string_id_617'), t('string_id_594')]
                    },
                    {
                        id: 306,
                        name: t('string_id_702'),
                        rupa: [t('string_id_607'), t('string_id_612'), t('string_id_617'), t('string_id_546'), t('string_id_600')]
                    },
                    {
                        id: 307,
                        name: t('string_id_703'),
                        rupa: [t('string_id_546')]
                    },
                    {
                        id: 308,
                        name: t('string_id_704'),
                        rupa: [t('string_id_607'), t('string_id_612'), t('string_id_617'), t('string_id_546')]
                    },
                ]
            },
            {
                name: t('string_id_705'),
                rupa: [],
                children: [
                    {
                        id: 309,
                        name: t('string_id_697'),
                        rupa: []
                    },
                    {
                        id: 310,
                        name: t('string_id_706'),
                        rupa: [t('string_id_546')]
                    },
                    {
                        id: 311,
                        name: t('string_id_700'),
                        rupa: [t('string_id_607'), t('string_id_612'), t('string_id_617')]
                    },
                    {
                        id: 312,
                        name: t('string_id_707'),
                        rupa: [t('string_id_546'), t('string_id_607'), t('string_id_612'), t('string_id_617')]
                    },
                ]
            },
            {
                name: t('string_id_708'),
                rupa: [],
                children: [
                    {
                        id: 313,
                        name: t('string_id_697'),
                        rupa: []
                    },
                    {
                        id: 314,
                        name: t('string_id_700'),
                        rupa: [t('string_id_607'), t('string_id_612'), t('string_id_617')]
                    },
                ]
            }
        ]
    };

const interactiveItems = [];
const highlightableItems = {};
const rupaIndex = {};
function renderRupaAttrTable(parent) {
    const lang = getLang();
    const fontSize = 12; // px
    const padding = 3;
    const unit = fontSize + padding * 2;
    const columnHeaderLines = (lang.wide ? 2 : 2.5);
    const columnHeaderH = unit * columnHeaderLines;
    const w1 = lang.wide ? unit : fontSize * 4 + padding * 2;
    const w2 = lang.wide ? fontSize * 3 + padding * 2 : fontSize * 5 + padding * 2;
    const subRowHeadersW = lang.wide ? fontSize * 4 + padding * 2 : fontSize * 8 + padding * 2;
    const rowHeaderW = w1 + w2 + subRowHeadersW;
    function renderCornerCell(x, w) {
        renderCell(parent, x, 0, w, columnHeaderH, 'lightcyan');
    }

    const colx = [];
    function renderColumnHeaders(x, y) {
        let rx = x;
        colx.push(rx);
        rupaClass.forEach(function (data, i) {
            let w = getWordLength(data.name, fontSize) / columnHeaderLines + padding * 3;
            data.values.forEach(d => {
                let dw = getWordLength(d, fontSize) + padding * 3;
                w = Math.max(w, dw);
            });
            if (lang.wide && (i === 7 || i === 4)) {
                w += fontSize;
            }
            renderTextBox(parent, rx, y, w, columnHeaderH, 'lightcyan', data.name, {size: fontSize});
            rx += w;
            colx.push(rx);
        });
    }

    let rupas = [];
    function renderRowHeaderGroups(x, y, depth, data) {
        if (!data.children) {
            if (data.id > 0) {
                rupas.push(data);
            }
            return {count: data.id > 0};
        }
        let count = 0;
        const xOffset = depth === 0 ? 0 : w1;
        data.children.forEach(d => {
            const res = renderRowHeaderGroups(x + xOffset, y + count * unit, depth + 1, d);
            count += res.count;
        })
        if (depth === 2) {
            renderTextBox(parent, x, y, w2, unit * count, 'lightcyan', data.name, {size: fontSize});
        } else if (depth === 1) {
            renderTextBox(parent, x, y, w1, unit * count, 'lightcyan', data.name, {size: fontSize});
        }
        return {count: count};
    }

    function renderRowHeaders(x, y) {
        rupas.forEach((d, i) => {
            const item = renderTextBox(parent, x, y + i * unit, subRowHeadersW, unit, 'white', d.alias || d.name, {wrap: false, size: fontSize});
            interactiveItems.push({
                id: d.id,
                item: item,
            });
            if (!highlightableItems[d.id]) {
                highlightableItems[d.id] = [];
            }
            highlightableItems[d.id].push(item);
        });
    }

    function renderGrid() {
        rupas.forEach(d => {
            rupaIndex[d.name] = d;
        });
        rupaClass.forEach(((d, i) => {
            const x = colx[i];
            // positive, negative, neutral
            const colors = ['lightgreen', 'lightyellow', 'lightblue'];
            rupas.forEach((r, j) => {
                const y = columnHeaderH + unit * j;
                let color = colors[1];
                let text = d.values[1];
                if (d.rupa.includes(r.name)) {
                    color = colors[0];
                    text = d.values[0];
                } else if (d.extra && d.extra.includes(r.name)) {
                    color = colors[2];
                    text = d.values[2];
                }
                const item = renderTextBox(parent, x, y, colx[i + 1] - colx[i], unit, color, text, {size: fontSize});
                highlightableItems[r.id].push(item);
            });
        }));
    }

    renderCornerCell(0, rowHeaderW);
    renderColumnHeaders(rowHeaderW, 0);
    renderRowHeaderGroups(0, columnHeaderH, 0, rupa);
    renderRowHeaders(w1 + w2, columnHeaderH);

    // render again for rupa table
    renderCornerCell(colx[9], subRowHeadersW);
    renderRowHeaders(colx[9], columnHeaderH); //right side headers

    renderGrid();

    const eightBasics = [t('string_id_502'), t('string_id_507'), t('string_id_511'), t('string_id_515'), t('string_id_729'), t('string_id_550'), t('string_id_554'), t('string_id_581')];
    const ebIndex = [];
    eightBasics.forEach((d) => {
        ebIndex.push(rupaIndex[d].id);
    });
    const endX = colx[9] + subRowHeadersW;
    let min = 99;
    let max = 0;
    const len = 20;
    const b = columnHeaderLines * unit;
    ebIndex.forEach(d => {
        min = Math.min(min, d);
        max = Math.max(max, d);
        parent.append('line')
            .attr('x1', endX)
            .attr('y1', b + unit * d - unit / 2)
            .attr('x2', endX + len)
            .attr('y2', b + unit * d - unit / 2)
            .attr('stroke', 'black')
            .attr('stroke-width', 1);
    });
    parent.append('line')
        .attr('x1', endX + len)
        .attr('y1', b + unit * min - unit / 2)
        .attr('x2', endX + len)
        .attr('y2', b + unit * max - unit / 2)
        .attr('stroke', 'black')
        .attr('stroke-width', 1);

    parent.append('line')
        .attr('x1', endX + len)
        .attr('y1', b + unit * (min + 2) / 2 - unit / 2)
        .attr('x2', endX + len * 2)
        .attr('y2', b + unit * (min + 2) / 2 - unit / 2)
        .attr('stroke', 'black')
        .attr('stroke-width', 1);

    const vertical = lang.vertical;
    const tbW = vertical ? unit : unit * 4;
    const tbH = vertical ? unit * 4 : unit * 2;
    renderTextBox(parent, endX + len * 2, b + unit * min- unit / 2, tbW, tbH, 'lavender', t('string_id_709'), {size: fontSize});


    const threeChange = [t('string_id_607'), t('string_id_612'), t('string_id_617')];
    const tcIndex = [];
    threeChange.forEach((d) => {
        tcIndex.push(rupaIndex[d].id);
    });
    let tcMin = 99;
    let tcMax = 0;
    tcIndex.forEach(d => {
        tcMin = Math.min(tcMin, d);
        tcMax = Math.max(tcMax, d);
        parent.append('line')
            .attr('x1', endX)
            .attr('y1', b + unit * d - unit / 2)
            .attr('x2', endX + len)
            .attr('y2', b + unit * d - unit / 2)
            .attr('stroke', 'black')
            .attr('stroke-width', 1);
    });
    parent.append('line')
        .attr('x1', endX + len)
        .attr('y1', b + unit * tcMin - unit / 2)
        .attr('x2', endX + len)
        .attr('y2', b + unit * tcMax - unit / 2)
        .attr('stroke', 'black')
        .attr('stroke-width', 1);
    parent.append('line')
        .attr('x1', endX + len)
        .attr('y1', b + unit * (tcMin + tcMax) / 2 - unit / 2)
        .attr('x2', endX + len * 2)
        .attr('y2', b + unit * (tcMin + tcMax) / 2 - unit / 2)
        .attr('stroke', 'black')
        .attr('stroke-width', 1);
    const tbW2 = vertical ? unit : unit * 4;
    const tbH2 = vertical ? unit * 3 : unit * 2;
    renderTextBox(parent, endX + len * 2, columnHeaderH + unit * (tcMin + tcMax) / 2 - unit/2 - tbH2/2, tbW2, tbH2, 'lightblue', t('string_id_606'), {size: fontSize});

    return {
        endX: endX,
        endY: unit * 28 + columnHeaderH
    };
}

function renderNotesTable(parent, x, y) {
    const fontSize = 12; // px
    const padding = 3;
    const unit = fontSize * 2 + padding * 2;
    const columnHeaderH = fontSize + padding * 2;
    const columnW = fontSize * 11 + padding;
    let rupas = [];
    const lang = getLang();
    const subRowHeadersW = lang.wide ? fontSize * 4 + padding * 2 : fontSize * 8 + padding * 2;
    function gatherRupas(data) {
        if (!data.children) {
            rupas.push(data);
            if (data.id < 0) {
                highlightableItems[data.id] = [];
            }
            return;
        }
        data.children.forEach(d => {
            gatherRupas(d);
        });
    }

    function renderRowHeaders(x, y) {
        rupas.forEach((d, i) => {
            const item = renderTextBox(parent, x, y + i * unit, subRowHeadersW, unit, 'white', d.alias || d.name, {size: fontSize});
            interactiveItems.push({
                item: item,
                id: d.id
            });
            highlightableItems[d.id].push(item);
        });
    }
    function renderColumnHeaders(x, y) {
        [t('string_id_3'), t('string_id_4'), t('string_id_5'), t('string_id_6')].forEach(((d, i) => {
            renderTextBox(parent, x + i * columnW, y, columnW, columnHeaderH, 'lightcyan', d, {size: fontSize});
        }));
    }
    function renderGrid(x, y) {
        rupas.forEach((d, i) => {
            const cItem = renderTextBox(parent, x, y + i * unit, columnW, unit, 'lightyellow', d.character, {size: fontSize});
            highlightableItems[d.id].push(cItem);
            const fItem = renderTextBox(parent, x + columnW, y + i * unit, columnW, unit, 'lightyellow', d.functions, {size: fontSize});
            highlightableItems[d.id].push(fItem);
            const mItem = renderTextBox(parent, x + columnW * 2, y + i * unit, columnW, unit, 'lightyellow', d.manifestation, {size: fontSize});
            highlightableItems[d.id].push(mItem);
            const caItem = renderTextBox(parent, x + columnW * 3, y + i * unit, columnW, unit, 'lightyellow', d.cause, {size: fontSize});
            highlightableItems[d.id].push(caItem);
        });
    }

    gatherRupas(rupa);
    renderCell(parent, x, y, subRowHeadersW, columnHeaderH, 'white');
    renderRowHeaders(x, y + columnHeaderH);
    renderColumnHeaders(x + subRowHeadersW, y);
    renderGrid(x + subRowHeadersW, y + columnHeaderH);
}

function renderRupaAggTable(parent, x, y) {
    const fontSize = 12; // px
    const padding = 3;
    const unit = fontSize + padding * 4;

    function isSubset(array1, array2) {
        // Check if every element of array2 is included in array1
        return array2.every(element => array1.includes(element));
    }

    function setSubtraction(array1, array2) {
        // Return elements in array1 that are not in array2
        return array1.filter(element => !array2.includes(element));
    }

    function renderAgg(parent, x, y, data, rupas) {
        const lang = getLang();
        if (lang.fixed) {
            renderAggCN(parent, x, y, data, rupas);
        } else {
            renderAggEN(parent, x, y, data, rupas);
        }
    }

    function renderAggEN(parent, x, y, data, rupas) {
        const w = 250;
        if (!data.children) {
            let ry = y;
            let rx = x;
            const item = renderTextBox(parent, rx, ry, w, unit, 'white', data.name, {size: fontSize});
            interactiveItems.push({
                item: item,
                id: data.id
            });
            highlightableItems[data.id] = [item];
            ry += unit;
            renderTextBox(parent, rx, ry, w * 0.4, unit, 'lavender', t('string_id_709'), {size: fontSize});
            rx = x + w * 0.4;
            const changeRupa = [t('string_id_607'), t('string_id_612'), t('string_id_617')];
            if (isSubset(rupas, changeRupa)) {
                renderTextBox(parent, rx, ry, w * 0.3, unit, 'lightblue', t('string_id_606'), {size: fontSize});
                rx += w * 0.3;
                changeRupa.forEach(d => {
                    const items = highlightableItems[rupaIndex[d].id];
                    highlightableItems[data.id].push(...items);
                });

            }
            const eightBasics = [t('string_id_502'), t('string_id_507'), t('string_id_511'), t('string_id_515'), t('string_id_729'), t('string_id_550'), t('string_id_554'), t('string_id_581')];
            eightBasics.forEach(d => {
                const items = highlightableItems[rupaIndex[d].id];
                highlightableItems[data.id].push(...items);
            });
            const otherRupas = setSubtraction(setSubtraction(rupas, eightBasics), changeRupa);
            const rw = (w - (rx - x)) / Math.max(otherRupas.length, 1);
            otherRupas.forEach((d, i) => {
                renderTextBox(parent, rx, ry, rw, unit, i === 0 ? 'lightgreen' : 'lightskyblue', d, {size: fontSize});
                rx += rw;
                const items = highlightableItems[rupaIndex[d].id];
                highlightableItems[data.id].push(...items);
            });
            return 0;
        }
        let count = 0;
        data.children.forEach((data, i) => {
            const dx = data.children ? count * w : 0;
            const dy =  data.children ? 0 : i * 2 * unit;
            count += renderAggEN(parent, x + dx, y + unit + dy, data, rupas.concat(data.rupa));
        });
        count = Math.max(1, count);
        renderTextBox(parent, x, y, count * w, unit, 'lightcyan', data.name, {size: fontSize});
        return count;
    }

    function renderAggCN(parent, x, y, data, rupas) {
        if (!data.children) {
            let ry = y;
            const h1 = 13 * fontSize;
            const item = renderTextBox(parent, x, ry, unit, h1, 'white', data.name, {vertical: true, size: fontSize});
            interactiveItems.push({
                item: item,
                id: data.id
            });
            highlightableItems[data.id] = [item];
            ry += h1;
            const h2 = fontSize*4 + padding * 4;
            renderTextBox(parent, x, ry, unit, h2, 'lavender', t('string_id_709'), {vertical: true, size: fontSize});
            ry += h2;
            const changeRupa = [t('string_id_607'), t('string_id_612'), t('string_id_617')];
            if (isSubset(rupas, changeRupa)) {
                const h3 = fontSize*3 + padding * 4;
                renderTextBox(parent, x, ry, unit, h3, 'lightblue', t('string_id_606'), {vertical: true, size: fontSize});
                ry += h3;
                changeRupa.forEach(d => {
                    const items = highlightableItems[rupaIndex[d].id];
                    highlightableItems[data.id].push(...items);
                });

            }
            const eightBasics = [t('string_id_502'), t('string_id_507'), t('string_id_511'), t('string_id_515'), t('string_id_729'), t('string_id_550'), t('string_id_554'), t('string_id_581')];
            eightBasics.forEach(d => {
                const items = highlightableItems[rupaIndex[d].id];
                highlightableItems[data.id].push(...items);
            });
            const otherRupas = setSubtraction(setSubtraction(rupas, eightBasics), changeRupa);
            otherRupas.forEach((d, i) => {
                const h = d.length * fontSize + padding*4;
                renderTextBox(parent, x, ry, unit, h, i === 0 ? 'lightgreen' : 'lightskyblue', d, {vertical: true, size: fontSize});
                ry += h;
                const items = highlightableItems[rupaIndex[d].id];
                highlightableItems[data.id].push(...items);
            });
            return 1;
        }
        let count = 0;
        data.children.forEach((data, i) => {
            count += renderAggCN(parent, x + count * unit, y + unit, data, rupas.concat(data.rupa));
        });
        renderTextBox(parent, x, y, count * unit, unit, 'lightcyan', data.name, {size: fontSize});
        return count;
    }

    renderAgg(parent, x, y, rupaAgg, []);
}

let rupaLock = null;
function setupRupaHighlightBehavior() {
    interactiveItems.forEach((item, i) => {
        item.highlight = function () {
            const subItems = highlightableItems[item.id];
            subItems.forEach((d, i) => {
                d.highlight();
            });
        }
        item.clear = function () {
            const subItems = highlightableItems[item.id];
            subItems.forEach((d, i) => {
                d.clear();
            });
        }
        item.item.on('mouseover', function(event, d) {
                if (rupaLock) return;
                item.highlight();
            })
            .on('mousemove', function(event) {
            })
            .on('mouseout', function() {
                if (rupaLock) return;
                item.clear();
            })
            .on('click', function() {
                if (rupaLock === item) {
                    rupaLock = null;
                    item.clear();
                } else {
                    if (rupaLock) {
                        rupaLock.clear();
                    }
                    rupaLock = item;
                    item.highlight();
                }
            });
    });
}
