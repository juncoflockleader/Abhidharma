const rupa = {
    name: "28色",
    children: [
        {
            name: "四大",
            children: [
                {
                    name: "大种色",
                    children: [
                        {
                            name: "地",
                            id: 1,
                            character: "硬性",
                            functions: "支持统一粒色聚里的其他色法",
                            manifestation: "接受同一色聚里的其他色法住于其上",
                            cause: "其他三界"
                        },
                        {
                            name: "水",
                            id: 2,
                            character: "流动",
                            functions: "展布其他俱生色法",
                            manifestation: "粘着同一色聚里的其他色法",
                            cause: "其他三界"
                        },
                        {
                            name: "火",
                            id: 3,
                            character: "热或冷",
                            functions: "使同一粒色聚里的其他色法成熟",
                            manifestation: "不断地使同一色聚柔软",
                            cause: "其他三界"
                        },
                        {
                            name: "风",
                            id: 4,
                            character: "撑持；刚强",
                            functions: "移动、推",
                            manifestation: "带动其他俱生色法移位",
                            cause: "其他三界"
                        },
                    ]
                }
            ]
        },
        {
            name: "四大所造色",
            children: [
                {
                    name: "净色",
                    children: [
                        {
                            name: "眼净色",
                            id: 5,
                            character: "可接受色所缘撞击的四大种之净色",
                            functions: "引心路至色所缘",
                            manifestation: "作为眼识的依处",
                            cause: "想见的因缘之业生种色(同一粒色聚里的四大)"
                        },
                        {
                            name: "耳净色",
                            id: 6,
                            character: "可接受声所缘撞击的四大种之净色",
                            functions: "引心路至声所缘",
                            manifestation: "作为耳识的依处",
                            cause: "想听的因缘之业生种色(同一粒色聚里的四大)"
                        },
                        {
                            name: "鼻净色",
                            id: 7,
                            character: "可接受香所缘撞击的四大种之净色",
                            functions: "引心路至香所缘",
                            manifestation: "作为鼻识的依处",
                            cause: "想嗅的因缘之业生种色(同一粒色聚里的四大)"
                        },
                        {
                            name: "舌净色",
                            id: 8,
                            character: "可接受味所缘撞击的四大种之净色",
                            functions: "引心路至味所缘",
                            manifestation: "作为舌识的依处",
                            cause: "想尝的因缘之业生种色(同一粒色聚中的四大)"
                        },
                        {
                            name: "身净色",
                            id: 9,
                            character: "可接受触所缘撞击的四大种之净色",
                            functions: "引心路至触所缘",
                            manifestation: "作为身识的依处",
                            cause: "想触的因缘之业生种色(同一粒色聚里的四大)"
                        },
                    ]
                },
                {
                    name: "境色",
                    children: [
                        {
                            name: "色",
                            id: 10,
                            character: "撞击眼净色",
                            functions: "作为眼识的目标",
                            manifestation: "作为眼识之境",
                            cause: "同一粒色聚里的四大"
                        },
                        {
                            name: "声",
                            id: 11,
                            character: "撞击耳净色",
                            functions: "作为耳识的目标",
                            manifestation: "作为耳识之境",
                            cause: "同一粒色聚里的四大"
                        },
                        {
                            name: "香",
                            id: 12,
                            character: "撞击鼻净色",
                            functions: "作为鼻识的目标",
                            manifestation: "作为鼻识之境",
                            cause: "同一粒色聚里的四大"
                        },
                        {
                            name: "味",
                            id: 13,
                            character: "撞击舌净色",
                            functions: "作为舌识的目标",
                            manifestation: "作为舌识之境",
                            cause: "同一粒色聚里的四大"
                        },
                        {
                            name: "触",
                            alias: "地火风",
                            id: -1,
                            character: "撞击身净色",
                            functions: "作为身识的目标",
                            manifestation: "作为身识之境",
                            cause: "同一粒色聚里的四大"
                        },
                    ]
                },
                {
                    name: "性根色",
                    children: [
                        {
                            name: "女根色",
                            id: 14,
                            character: "女性",
                            functions: "显示是女性",
                            manifestation: "女性、女相、女性行为、女性特征",
                            cause: "同一粒色聚里的业生四大"
                        },
                        {
                            name: "男根色",
                            id: 15,
                            character: "男性",
                            functions: "显示是男性",
                            manifestation: "男性、男相、男性行为、男性特征",
                            cause: "同一粒色聚里的业生四大"
                        },
                    ]
                },
                {
                    name: "心色",
                    children: [
                        {
                            name: "心色",
                            id: 16,
                            alias: "心所依处",
                            character: "提供意界和意识界的依处",
                            functions: "作为意界和意识界的依处",
                            manifestation: "撑此意界和意识界",
                            cause: "同一粒色聚里的业生四大"
                        },
                    ]
                },
                {
                    name: "命根色",
                    children: [
                        {
                            name: "命根色",
                            id: 17,
                            character: "维护在住时的俱生业生色",
                            functions: "使到俱生业生色发生",
                            manifestation: "维持这些业生色存在",
                            cause: "同一粒色聚里的业生四大"
                        },
                    ]
                },
                {
                    name: "食色",
                    children: [
                        {
                            name: "食色",
                            alias: "食素",
                            id: 18,
                            character: "所吃食物里之营养",
                            functions: "滋养色法",
                            manifestation: "制造食生色维持身体",
                            cause: "必须受到它滋养的处色"
                        },
                    ]
                },
                {
                    name: "限界色",
                    children: [
                        {
                            name: "限界色",
                            alias: "空界",
                            id: 19,
                            character: "划定色聚的界限",
                            functions: "显示色聚的边际",
                            manifestation: "色聚的界限/之间的孔隙",
                            cause: "应被区划的色聚"
                        },
                    ]
                },
                {
                    name: "表色",
                    children: [
                        {
                            name: "身表色",
                            id: 20,
                            character: "由心生风界带动动作，令俱生色身稳定或移动。",
                            functions: "通过动作表示自己的意志",
                            manifestation: "作为身体转动之因",
                            cause: "心生风界",
                            extra: "（风界之力过强的心生大种）"
                        },
                        {
                            name: "语表色",
                            id: 21,
                            character: "制造声音的地界互相撞击，而有语言的表达。",
                            functions: "通过语言表达自己的意志",
                            manifestation: "作为语言之因",
                            cause: "心生地界",
                            extra: "（地界过强的心生大种）"
                        },
                    ]
                },
                {
                    name: "变化色",
                    children: [
                        {
                            name: "色轻快性",
                            id: 22,
                            character: "心生色、时节生色与食生色的不重与不迟钝",
                            functions: "去除这些色法的重性",
                            manifestation: "这些色法轻快地升起及变易",
                            cause: "轻快的色"
                        },
                        {
                            name: "色柔软性",
                            id: 23,
                            character: "心生色、时节生色与食生色的不坚固与不粗",
                            functions: "去除这些色法的坚硬性与粗性",
                            manifestation: "不对抗身体的一切作业",
                            cause: "柔软的色"
                        },
                        {
                            name: "色适业性",
                            id: 24,
                            character: "心生色、时节生色与食生色的适应性",
                            functions: "去除由风界不平衡的不适应性",
                            manifestation: "这些色法的不软弱",
                            cause: "适业的色"
                        },
                    ]
                },
                {
                    name: "相色",
                    children: [
                        {
                            name: "色积集",
                            id: 25,
                            character: "色法的起始/成长至诸根具足",
                            functions: "令色法开始生起",
                            manifestation: "起始或完成的状态",
                            cause: "生起之色法"
                        },
                        {
                            name: "色相续",
                            id: 26,
                            character: "诸根具足后色法的持续",
                            functions: "一个接一个地连续结合",
                            manifestation: "持续而不间断",
                            cause: "结合的色法"
                        },
                        {
                            name: "色老性",
                            id: 27,
                            character: "色法成熟与老化",
                            functions: "导致坏灭、死亡",
                            manifestation: "失去新性",
                            cause: "正在衰老的色法"
                        },
                        {
                            name: "色无常",
                            id: 28,
                            character: "真实色法完全坏灭",
                            functions: "令真实色法消失",
                            manifestation: "真实色法灭尽",
                            cause: "灭尽的真实色法"
                        },
                    ]
                }
            ]
        }
    ]
};

const rupaClass = [
    {
        name: "内色",
        id: 101,
        values: ["内", "外"],
        notes: "作为名法之门的五净色",
        rupa: ["眼净色", "耳净色", "鼻净色", "舌净色", "身净色"]
    },
    {
        name: "所依色",
        id: 102,
        values: ["所依", "非所依"],
        notes: "六识所依之色法",
        rupa: ["眼净色", "耳净色", "鼻净色", "舌净色", "身净色", "心色"]
    },
    {
        name: "门色",
        id: 103,
        values: ["门", "非门"],
        notes: "五净色:心与目标之门;表色:造身语业之门",
        rupa: ["眼净色", "耳净色", "鼻净色", "舌净色", "身净色", "身表色", "语表色"]
    },
    {
        name: "根色",
        id: 104,
        values: ["根", "非根"],
        notes: "有控制力",
        rupa: ["眼净色", "耳净色", "鼻净色", "舌净色", "身净色", "男根色", "女根色", "命根色"]
    },
    {
        name: "粗/近/有对色",
        id: 105,
        values: ["粗/近/有对", "细/远/非有对"],
        notes: "直接使根识生起的色法",
        rupa: ["地", "火", "风", "眼净色", "耳净色", "鼻净色", "舌净色", "身净色", "色", "声", "香", "味"]
    },
    {
        name: "执受色",
        id: 106,
        values: ["执受", "非执受", "皆可"],
        notes: "渴爱与邪见推动而造下的业的果报",
        rupa: ["眼净色", "耳净色", "鼻净色", "舌净色", "身净色", "男根色", "女根色", "心色", "命根色"],
        extra: ["地", "水", "火", "风", "色", "香", "味", "食色", "限界色"]
    },
    {
        name: "可见色",
        id: 107,
        values: ["可见", "不可见", "皆可"],
        notes: "可被眼见得知",
        rupa: [],
        extra: ["色"]
    },
    {
        name: "取境色",
        id: 108,
        values: ["到达境", "不取境", "不到达境"],
        notes: "五净色取五境为目标",
        rupa: ["眼净色", "耳净色"],
        extra: ["鼻净色", "舌净色", "身净色"]
    },
    {
        name: "不分离色",
        id: 109,
        values: ["不分离", "分离"],
        notes: "四大元素与色香味食色存在于一切色聚中",
        rupa: ["地", "水", "火", "风", "色", "香", "味", "食色"]
    },
];

const rupaCause = {
    name: "四因",
    rupa: ["地", "水", "火", "风", "色", "香", "味", "食色"],
    children: [
        {
            name: "业生色",
            id: 201,
            rupa: ["眼净色", "耳净色", "鼻净色",
                "舌净色", "身净色", "女根色", "男根色",
                "心色", "命根色", "限界色"]
        },
        {
            name: "心生色",
            id: 202,
            rupa: ["声", "限界色", "身表色", "语表色", "色轻快性", "色柔软性", "色适业性"]
        },
        {
            name: "时节生色",
            id: 203,
            rupa: ["声", "限界色", "色轻快性", "色柔软性", "色适业性"]
        },
        {
            name: "食生色",
            id: 204,
            rupa: ["限界色", "色轻快性", "色柔软性", "色适业性"]
        }
    ]
};

const rupaAgg =
    {
        name: "23色聚",
        rupa: ["地", "水", "火", "风", "色", "香", "味", "食色"],
        children: [
            {
                name: "业生",
                rupa: ["命根色"],
                children: [
                    {
                        name: "眼十法聚",
                        id: 315,
                        rupa: ["眼净色"]
                    },
                    {
                        name: "耳十法聚",
                        id: 316,
                        rupa: ["耳净色"]
                    },
                    {
                        name: "鼻十法聚",
                        id: 317,
                        rupa: ["鼻净色"]
                    },
                    {
                        name: "舌十法聚",
                        id: 318,
                        rupa: ["舌净色"]
                    },
                    {
                        name: "身十法聚",
                        id: 319,
                        rupa: ["身净色"]
                    },
                    {
                        name: "女根色十法聚",
                        id: 320,
                        rupa: ["女根色"]
                    },
                    {
                        name: "男根色十法聚",
                        id: 321,
                        rupa: ["男根色"]
                    },
                    {
                        name: "心色十法聚",
                        id: 322,
                        rupa: ["心色"]
                    },
                    {
                        name: "命九法聚",
                        id: 323,
                        rupa: []
                    },
                ]
            },
            {
                name: "心生",
                rupa: [],
                children: [
                    {
                        id: 301,
                        name: "纯八法聚",
                        rupa: []
                    },
                    {
                        id: 302,
                        name: "身表九法聚",
                        rupa: ["身表色"]
                    },
                    {
                        id: 303,
                        name: "语表十法聚",
                        rupa: ["声", "语表色"]
                    },
                    {
                        id: 304,
                        name: "轻快性十一法聚",
                        rupa: ["色轻快性", "色柔软性", "色适业性"]
                    },
                    {
                        id: 305,
                        name: "身表轻快性十二法聚",
                        rupa: ["色轻快性", "色柔软性", "色适业性", "身表色"]
                    },
                    {
                        id: 306,
                        name: "语表声轻快性十三法聚",
                        rupa: ["色轻快性", "色柔软性", "色适业性", "声", "语表色"]
                    },
                    {
                        id: 307,
                        name: "非语言的声九法聚",
                        rupa: ["声"]
                    },
                    {
                        id: 308,
                        name: "非语言的声轻快性十二法聚",
                        rupa: ["色轻快性", "色柔软性", "色适业性", "声"]
                    },
                ]
            },
            {
                name: "时节生",
                rupa: [],
                children: [
                    {
                        id: 309,
                        name: "纯八法聚",
                        rupa: []
                    },
                    {
                        id: 310,
                        name: "声九法聚",
                        rupa: ["声"]
                    },
                    {
                        id: 311,
                        name: "轻快性十一法聚",
                        rupa: ["色轻快性", "色柔软性", "色适业性"]
                    },
                    {
                        id: 312,
                        name: "声轻快性十一法聚",
                        rupa: ["声", "色轻快性", "色柔软性", "色适业性"]
                    },
                ]
            },
            {
                name: "食生",
                rupa: [],
                children: [
                    {
                        id: 313,
                        name: "纯八法聚",
                        rupa: []
                    },
                    {
                        id: 314,
                        name: "轻快性十一法聚",
                        rupa: ["色轻快性", "色柔软性", "色适业性"]
                    },
                ]
            }
        ]
    };

const interactiveItems = [];
const highlightableItems = {};
const rupaIndex = {};
function renderRupaAttrTable(parent) {
    const fontSize = 12; // px
    const padding = 3;
    const unit = fontSize + padding * 2;
    const columnHeaderH = unit;
    const subRowHeadersW = fontSize * 4 + padding * 2;
    const rowHeaderW = unit + 7 * fontSize + 4 * padding;
    function renderCornerCell(x, w) {
        renderCell(parent, x, 0, w, columnHeaderH, 'lightcyan');
    }

    const colx = [];
    function renderColumnHeaders(x, y) {
        let rx = x;
        colx.push(rx);
        rupaClass.forEach(function (data, i) {
            let w = getWordLength(data.name, fontSize) + padding * 2;
            if (i === 7 || i === 4) {
                w += fontSize;
            }
            renderTextBox(parent, rx, y, w, columnHeaderH, 'lightcyan', data.name, {size: fontSize});
            rx += w;
            colx.push(rx);
        });
    }

    let rupas = [];
    function renderRowHeaderGroups(x, y, depth, data) {
        if (!data.children) {
            if (data.id > 0) {
                rupas.push(data);
            }
            return {count: data.id > 0};
        }
        let count = 0;
        const xOffset = depth === 0 ? 0 : unit;
        data.children.forEach(d => {
            const res = renderRowHeaderGroups(x + xOffset, y + count * unit, depth + 1, d);
            count += res.count;
        })
        if (depth === 2) {
            renderTextBox(parent, x, y, fontSize * 3 + padding * 2, unit * count, 'lightcyan', data.name, {size: fontSize});
        } else if (depth === 1) {
            renderTextBox(parent, x, y, unit, unit * count, 'lightcyan', data.name, {size: fontSize});
        }
        return {count: count};
    }

    function renderRowHeaders(x, y) {
        rupas.forEach((d, i) => {
            const item = renderTextBox(parent, x, y + i * unit, subRowHeadersW, unit, 'white', d.alias || d.name, {size: fontSize});
            interactiveItems.push({
                id: d.id,
                item: item,
            });
            if (!highlightableItems[d.id]) {
                highlightableItems[d.id] = [];
            }
            highlightableItems[d.id].push(item);
        });
    }

    function renderGrid() {
        rupas.forEach(d => {
            rupaIndex[d.name] = d;
        });
        rupaClass.forEach(((d, i) => {
            const x = colx[i];
            // positive, negative, neutral
            const colors = ['lightgreen', 'lightyellow', 'lightblue'];
            rupas.forEach((r, j) => {
                const y = columnHeaderH + unit * j;
                let color = colors[1];
                let text = d.values[1];
                if (d.rupa.includes(r.name)) {
                    color = colors[0];
                    text = d.values[0];
                } else if (d.extra && d.extra.includes(r.name)) {
                    color = colors[2];
                    text = d.values[2];
                }
                const item = renderTextBox(parent, x, y, colx[i + 1] - colx[i], unit, color, text, {size: fontSize});
                highlightableItems[r.id].push(item);
            });
        }));
    }

    renderCornerCell(0, rowHeaderW);
    renderColumnHeaders(rowHeaderW, 0);
    renderRowHeaderGroups(0, columnHeaderH, 0, rupa);
    renderRowHeaders(unit + fontSize * 3 + padding * 2, columnHeaderH);

    // render again for rupa table
    renderCornerCell(colx[9], subRowHeadersW);
    renderRowHeaders(colx[9], columnHeaderH); //right side headers

    renderGrid();

    const eightBasics = ["地", "水", "火", "风", "色", "香", "味", "食色"];
    const ebIndex = [];
    eightBasics.forEach((d) => {
        ebIndex.push(rupaIndex[d].id);
    });
    const endX = colx[9] + subRowHeadersW;
    let min = 99;
    let max = 0;
    const len = 20;
    ebIndex.forEach(d => {
        min = Math.min(min, d);
        max = Math.max(max, d);
        parent.append("line")
            .attr("x1", endX)
            .attr("y1", unit * d + unit / 2)
            .attr("x2", endX + len)
            .attr("y2", unit * d + unit / 2)
            .attr("stroke", "black")
            .attr("stroke-width", 1);
    });
    parent.append("line")
        .attr("x1", endX + len)
        .attr("y1", unit * min + unit / 2)
        .attr("x2", endX + len)
        .attr("y2", unit * max + unit / 2)
        .attr("stroke", "black")
        .attr("stroke-width", 1);

    parent.append("line")
        .attr("x1", endX + len)
        .attr("y1", unit * (min + 2) / 2 + unit / 2)
        .attr("x2", endX + len * 2)
        .attr("y2", unit * (min + 2) / 2 + unit / 2)
        .attr("stroke", "black")
        .attr("stroke-width", 1);

    renderTextBox(parent, endX + len * 2, unit * min, unit, unit * 4, 'lavender', '八不离色', {size: fontSize});


    const threeChange = ["色轻快性", "色柔软性", "色适业性"];
    const tcIndex = [];
    threeChange.forEach((d) => {
        tcIndex.push(rupaIndex[d].id);
    });
    let tcMin = 99;
    let tcMax = 0;
    tcIndex.forEach(d => {
        tcMin = Math.min(tcMin, d);
        tcMax = Math.max(tcMax, d);
        parent.append("line")
            .attr("x1", endX)
            .attr("y1", unit * d + unit / 2)
            .attr("x2", endX + len)
            .attr("y2", unit * d + unit / 2)
            .attr("stroke", "black")
            .attr("stroke-width", 1);
    });
    parent.append("line")
        .attr("x1", endX + len)
        .attr("y1", unit * tcMin + unit / 2)
        .attr("x2", endX + len)
        .attr("y2", unit * tcMax + unit / 2)
        .attr("stroke", "black")
        .attr("stroke-width", 1);
    parent.append("line")
        .attr("x1", endX + len)
        .attr("y1", unit * (tcMin + tcMax) / 2 + unit / 2)
        .attr("x2", endX + len * 2)
        .attr("y2", unit * (tcMin + tcMax) / 2 + unit / 2)
        .attr("stroke", "black")
        .attr("stroke-width", 1);
    renderTextBox(parent, endX + len * 2, unit * tcMin, unit, unit * 3, 'lightblue', '变化色', {size: fontSize});

    return {
        endX: endX,
        endY: unit * 29
    };
}

function renderNotesTable(parent, x, y) {
    const fontSize = 12; // px
    const padding = 3;
    const unit = fontSize * 2 + padding * 2;
    const columnHeaderH = fontSize + padding * 2;
    const columnW = fontSize * 11 + padding;
    let rupas = [];
    const subRowHeadersW = fontSize * 4 + padding * 2;
    function gatherRupas(data) {
        if (!data.children) {
            rupas.push(data);
            if (data.id < 0) {
                highlightableItems[data.id] = [];
            }
            return;
        }
        data.children.forEach(d => {
            gatherRupas(d);
        });
    }

    function renderRowHeaders(x, y) {
        rupas.forEach((d, i) => {
            const item = renderTextBox(parent, x, y + i * unit, subRowHeadersW, unit, 'white', d.alias || d.name, {size: fontSize});
            interactiveItems.push({
                item: item,
                id: d.id
            });
            highlightableItems[d.id].push(item);
        });
    }
    function renderColumnHeaders(x, y) {
        ["特相", "作用", "现起", "近因"].forEach(((d, i) => {
            renderTextBox(parent, x + i * columnW, y, columnW, columnHeaderH, 'lightcyan', d, {size: fontSize});
        }));
    }
    function renderGrid(x, y) {
        rupas.forEach((d, i) => {
            const cItem = renderTextBox(parent, x, y + i * unit, columnW, unit, 'lightyellow', d.character, {size: fontSize});
            highlightableItems[d.id].push(cItem);
            const fItem = renderTextBox(parent, x + columnW, y + i * unit, columnW, unit, 'lightyellow', d.functions, {size: fontSize});
            highlightableItems[d.id].push(fItem);
            const mItem = renderTextBox(parent, x + columnW * 2, y + i * unit, columnW, unit, 'lightyellow', d.manifestation, {size: fontSize});
            highlightableItems[d.id].push(mItem);
            const caItem = renderTextBox(parent, x + columnW * 3, y + i * unit, columnW, unit, 'lightyellow', d.cause, {size: fontSize});
            highlightableItems[d.id].push(caItem);
        });
    }

    gatherRupas(rupa);
    renderCell(parent, x, y, subRowHeadersW, columnHeaderH, 'white');
    renderRowHeaders(x, y + columnHeaderH);
    renderColumnHeaders(x + subRowHeadersW, y);
    renderGrid(x + subRowHeadersW, y + columnHeaderH);
}

function renderRupaAggTable(parent, x, y) {
    const fontSize = 12; // px
    const padding = 3;
    const unit = fontSize + padding * 4;

    function isSubset(array1, array2) {
        // Check if every element of array2 is included in array1
        return array2.every(element => array1.includes(element));
    }

    function setSubtraction(array1, array2) {
        // Return elements in array1 that are not in array2
        return array1.filter(element => !array2.includes(element));
    }

    function renderAgg(parent, x, y, data, rupas) {
        if (!data.children) {
            let ry = y;
            const h1 = 13 * fontSize;
            const item = renderTextBox(parent, x, ry, unit, h1, 'white', data.name, {vertical: true, size: fontSize});
            interactiveItems.push({
                item: item,
                id: data.id
            });
            highlightableItems[data.id] = [item];
            ry += h1;
            const h2 = fontSize*4 + padding * 4;
            renderTextBox(parent, x, ry, unit, h2, 'lavender', '八不离色', {vertical: true, size: fontSize});
            ry += h2;
            const changeRupa = ["色轻快性", "色柔软性", "色适业性"];
            if (isSubset(rupas, changeRupa)) {
                const h3 = fontSize*3 + padding * 4;
                renderTextBox(parent, x, ry, unit, h3, 'lightblue', '变化色', {vertical: true, size: fontSize});
                ry += h3;
                changeRupa.forEach(d => {
                    const items = highlightableItems[rupaIndex[d].id];
                    highlightableItems[data.id].push(...items);
                });

            }
            const eightBasics = ["地", "水", "火", "风", "色", "香", "味", "食色"];
            eightBasics.forEach(d => {
                const items = highlightableItems[rupaIndex[d].id];
                highlightableItems[data.id].push(...items);
            });
            const otherRupas = setSubtraction(setSubtraction(rupas, eightBasics), changeRupa);
            otherRupas.forEach((d, i) => {
                const h = d.length * fontSize + padding*4;
                renderTextBox(parent, x, ry, unit, h, i === 0 ? 'lightgreen' : "lightskyblue", d, {vertical: true, size: fontSize});
                ry += h;
                const items = highlightableItems[rupaIndex[d].id];
                highlightableItems[data.id].push(...items);
            });
            return 1;
        }
        let count = 0;
        data.children.forEach((data, i) => {
            count += renderAgg(parent, x + count * unit, y + unit, data, rupas.concat(data.rupa));
        });
        renderTextBox(parent, x, y, count * unit, unit, 'lightcyan', data.name, {size: fontSize});
        return count;
    }

    renderAgg(parent, x, y, rupaAgg, []);
}

let rupaLock = null;
function setupRupaHighlightBehavior() {
    interactiveItems.forEach((item, i) => {
        item.highlight = function () {
            const subItems = highlightableItems[item.id];
            subItems.forEach((d, i) => {
                d.highlight();
            });
        }
        item.clear = function () {
            const subItems = highlightableItems[item.id];
            subItems.forEach((d, i) => {
                d.clear();
            });
        }
        item.item.on("mouseover", function(event, d) {
                if (rupaLock) return;
                item.highlight();
            })
            .on("mousemove", function(event) {
            })
            .on("mouseout", function() {
                if (rupaLock) return;
                item.clear();
            })
            .on("click", function() {
                if (rupaLock === item) {
                    rupaLock = null;
                    item.clear();
                } else {
                    if (rupaLock) {
                        rupaLock.clear();
                    }
                    rupaLock = item;
                    item.highlight();
                }
            });
    });
}
